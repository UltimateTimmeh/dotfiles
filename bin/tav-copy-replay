#!/bin/bash
# Copy TAVIguide-pp task replay files.
# v1.0

# Functions


usage() {
    cat <<EOF

Usage: $(basename $0) [options] TASK SRCID TGTID

Copy the replay file necessary for executing TASK of case TGTID (which is
an instance of source case SRCID) in TAVIguide-pp. TASK can be one of
'feapre', 'feapreqc', 'feapost', 'feapostqc' or 'cfdpostqc'.

Options:

  -n : Dry run. Only show what would happen, but don't actually do anything.
  -l : List the available source cases.
  -t SRCTYPE : Specify the type of source case.
       The default source case type is 'BCH' (benchmark cases)
       Other options for the source case type are:
         - 'TAV' (production cases)
         - 'TST' (test cases)
       See section 'Source cases' for more info.
  -c TGTCASESDIR : Target cases directory.
       Also known in TAVIguide-pp as the cases_path where case TSTID can be
       found.
       The default target cases directory is:
         - '/test/cases'
  -r TGTREPLAYDIR : Target replay directory.
       This is where the copied replay file will be placed.
       The default target replay directory is:
         - '~/tavireplay'
  -u USER : Perform ssh and rsync operation(s) as this user.

Source cases:

  Source cases are located in subdirectories of 'feops1:/srv/webdav/TAV/
  Verification/SystemVerification/testdata', depending on the type:
    - 'BCH' for benchmark cases,
    - 'TAV' for production cases and
    - 'TST' for test cases.
  If you want to change source cases or make new ones available for testing
  purposes, this is where you do it.

Examples:

  1. Listing all production source cases:

       $ $(basename $0) -lt TAV

  2. Copying the replay file for executing the FEA preprocessing task of
     case TST000321 (which is an instance of production source case TAV000123)
     as user 'feops':

       $ $(basename $0) -u feops -t TAV feapre TAV000123 TST000321

  3. Typical copying of benchmark case replay files during TAVIguide testing
     will be done with the following task-specific commands:

       FEA Preprocessing     : $ $(basename $0) feapre BENCHID TESTID
       FEA Preprocessing  QC : $ $(basename $0) feapreqc BENCHID TESTID
       FEA Postprocessing    : $ $(basename $0) feapost BENCHID TESTID
       FEA Postprocessing QC : $ $(basename $0) feapostqc BENCHID TESTID
       CFD Postprocessing QC : $ $(basename $0) cfdpostqc BENCHID TESTID

EOF
}


element_not_in() {
    # Test if element $1 is not in array ${@:2}.
    local e
    for e in "${@:2}"; do [[ "$e" == "$1" ]] && return 1; done
    return 0
}


remote_ls() {
    # Do a remote ls for directory $2 on machine $1.
    local CONTENTS
    CONTENTS=$(ssh $1 "ls $2")
    echo "$CONTENTS"
}


# Process the arguments.
DRY=
LIST=0
SRCTYPE=BCH
TGTCASESDIR=/test/cases
TGTREPLAYDIR=$HOME/tavireplay
USER=

OPTIND=1 # Reset in case getopts has been used previously in the shell.

while getopts "nlt:c:r:u:" opt; do
    case "$opt" in
	n)  DRY=-n
	    ;;
	l)  LIST=1
	    ;;
	t)  SRCTYPE=$OPTARG
	    ;;
	c)  TGTCASESDIR=$OPTARG
	    ;;
	r)  TGTREPLAYDIR=$OPTARG
	    ;;
	u)  USER=$OPTARG
	    ;;
    esac
done

shift $((OPTIND-1))

# Set a few variables.
SRCCASESDIR=feops1:/srv/webdav/TAV/Verification/SystemVerification/testdata/$SRCTYPE
[ "$USER" != "" ] && {
    SRCCASESDIR=$USER@$SRCCASESDIR
}

SRCIDS=$(remote_ls ${SRCCASESDIR//:/ })
[ "$LIST" = "1" ] && {
    # If the -l option is used, only list available source cases.
    echo "The following source cases are available in '$SRCCASESDIR':"
    for ID in $SRCIDS; do
	echo "   $ID"
    done
    exit
}

VALIDTASKS=("feapre" "feapreqc" "feapost" "feapostqc" "cfdpostqc")
TASK=$1
[ -n "$TASK" ] || { usage; exit 111; }
if element_not_in "$TASK" "${VALIDTASKS[@]}"; then
    echo "Task code '$TASK' is invalid. The following task codes are valid:"
    echo "   ${VALIDTASKS[@]}"
    exit
fi

SRCIDS=($SRCIDS)
SRCID=$2
[ -n "$SRCID" ] || { usage; exit 111; }
if element_not_in "$SRCID" "${SRCIDS[@]}"; then
    echo "Source case '$SRCID' not available in '$SRCCASESDIR'."
    echo "Use the -l option to list available source cases."
    exit
fi

TGTID=$3
[ -n "$TGTID" ] || { usage; exit 111; }

SRCREPLAYDIR=$SRCCASESDIR/$SRCID/replay
SRCREPLAYFILE=$SRCREPLAYDIR/${SRCID}_replay.py

TGTCASESALT=${TGTCASESDIR//'/'/'-'}
TGTREPLAYFILE=$TGTREPLAYDIR/$TGTCASESALT-${TGTID}_$TASK.py

# Copy the replay file.
rsync -avhP $SRCREPLAYFILE $TGTREPLAYFILE $DRY

# End
